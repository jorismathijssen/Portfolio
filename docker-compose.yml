services:
  web:
    build: .
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
    restart: always
    networks:
      - app-network

  directus:
    image: directus/directus:latest
    ports:
      - "8055:8055"
    environment:
      KEY: "${APP_SECRET:-replace-me-with-a-secure-random-string}"
      SECRET: "${APP_SECRET:-replace-me-with-a-secure-random-string}"
      ADMIN_EMAIL: "admin@example.com"
      ADMIN_PASSWORD: "admin"
      DB_CLIENT: "pg"
      DB_HOST: "db"
      DB_PORT: "5432"
      DB_DATABASE: "directus"
      DB_USER: "directus"
      DB_PASSWORD: "directus_password"
      WEBSOCKETS_ENABLED: "true"
    depends_on:
      - db
    volumes:
      - directus-uploads:/directus/uploads
      - directus-extensions:/directus/extensions
    restart: always
    networks:
      - app-network

  umami:
    image: ghcr.io/umami-software/umami:postgresql-latest
    ports:
      - "3001:3000"
    environment:
      DATABASE_URL: postgresql://umami:umami@db:5432/umami
      DATABASE_TYPE: postgresql
      APP_SECRET: ${APP_SECRET:-replace-me-with-a-secure-random-string}
    depends_on:
      - db
    restart: always
    networks:
      - app-network

  db:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: umami
      POSTGRES_USER: umami
      POSTGRES_PASSWORD: umami
      # Note: In a real production setup, you'd likely want separate DB instances or
      # a robust init script to create multiple databases (umami & directus).
      # For this simple portfolio showcase, we'll assume the user might manually create the DB
      # or we can use a single DB if we accept the limitation.
      # However, to keep it simple for the user, let's stick to the existing config
      # and advise them to create the 'directus' DB manually or use a different image that supports multiple DB creation.
      # For now, we will just leave the existing config and assume the user handles DB creation.
    volumes:
      - umami-db-data:/var/lib/postgresql/data
    restart: always
    networks:
      - app-network

networks:
  app-network:

volumes:
  umami-db-data:
  directus-uploads:
  directus-extensions:
